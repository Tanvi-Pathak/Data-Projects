---
title: "Exploring Movies"
author: 
date: 
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

```

## Introduction:

Avatar 2: The Way of Water was recently released after a 14 year wait and received loads of attention from the whole world.
It was a 3 hour long movie that was only in theaters for a short amount of time, but received the most attention.
While many people thoroughly enjoyed the movie, some individuals like myself were slightly disappointed in the plot line.
The world was very keen on watching this movie that took 14 years to make after the first one had reached an all time high in terms of ratings and international box office gross.
The media reported the popularity of this new movie as well, but I wonder, was this popularity mainly due to the public's curiosity or was it actually a good movie?
Had people chosen to watch the movie because it was all the rage or did they genuinely enjoy it?
Here, I am aiming to determine what factors determine a film's success by its content or because of trends in the media.
These trends are usually what prompt people to go watch a film in a theater.
Thus, my overall question is: What factors work in combination to determine an upcoming films overall success.

```{r loading packages, include=FALSE}
library(tidyverse)
library(rvest)
library(polite)
library(httr)
library(XML)
library(janitor)
library(RColorBrewer)
library(tidytext)
library(textdata)
library(wordcloud)
library(stringr) 
library(jsonlite)
```

## Part 1:

For the first part of this project, I will be exploring the most profitable films.
For this, I will be scraping data from [The Numbers](https://www.the-numbers.com/movie/budgets/all) The website has multiple pages and each page has a data set of 100 films.
The database includes the information of 6,386 films across 63 different pages.
Since we will only be looking at the most profitable films, we do not have to really examine the films on the lower end. So for the purpose of this project, I will only be scraping the first 1000 films. If I wanted to scrape all 6000 films, R takes at least 10 minutes to run each loop so we can limit the run time by reducing the load. 
First I created a for loop that loops through the first 9 pages of the website and extracts the tables on each page containing information about the movie name, release date budget, domestic gross, and worldwide gross.
It is important to politely obtain this data from the website.

```{r part 1a, cache=TRUE, include=FALSE}

page_num <- seq.int(101, 901, by = 100)
url <- "https://www.the-numbers.com/movie/budgets/all"
urls <- paste0("https://www.the-numbers.com/movie/budgets/all/", page_num)

robotstxt::paths_allowed(url)
robotstxt::paths_allowed(urls)

numbers_initial <- read_html(url) |>
  html_table() %>%
  .[[1]] |>
  select(Movie, ProductionBudget, WorldwideGross)

numbers_complete <- data.frame()

for (i in seq_along(urls)) {
  Sys.sleep(runif(5))
  numbers <- bow(urls[i]) |>
    scrape() |>
    html_table() %>%
    .[[1]] |>
  select(Movie, ProductionBudget, WorldwideGross)

  
  numbers_complete <- bind_rows(numbers_complete, numbers)
}

numbers_complete <- bind_rows(numbers_initial , numbers_complete)

```

Now that we have the data, lets look more closely at its contents.
Before we do so, we need to perform a few cleaning operations.
This data set contains information about unreleased movies as well as Netflix/other streaming platform originals.
This means that there is no box office gross for these films.
Hence, I will remove the films that made \$0 in the box office so we only limit the data set to released films that played in theaters.
Next I am going to turn the character variables into numeric data so we can perform some mutating operations on it.
We are only going to be looking at the movie, production budget, profit, and return on investment variables so we can removing the other irrelevant variables.
It would like to calculate the profit earned by a film as worldwide gross - production budget and the Return on Investment rate as (profit/production budget)\*100

```{r part 1b(cleaning)}
numbers_cleaned <- numbers_complete |>
  clean_names() |>
  mutate(production_budget = parse_number(production_budget),
         worldwide_gross = parse_number(worldwide_gross), 
         profit = worldwide_gross - production_budget,
         ROI = (profit/production_budget) * 100) |>
  filter(!worldwide_gross == 0) |>
  select(movie, production_budget, profit, ROI)
  
```

## Exploring Profitability of a Film:

Lets compare the top 10 films with the highest profit versus those with the highest budget and view the return on investment of the most profitable films.
Meaning that we will look at a graph with the top 20 films with the highest budgets, the top 20 films with the highest profit, and the top 20 films with the highest ROI and compare them.
The ROI gives us the measure of efficiency on profitability.
Was the investment worth it?

```{r part 1c}
numbers_cleaned |>
  arrange(desc(production_budget)) |>
  slice_max(production_budget, n = 20) |>
  mutate(movie = fct_reorder(movie, production_budget)) |>
  ggplot(aes(x = movie, y = production_budget)) +
  geom_col(fill = "thistle") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  theme_bw() +
  ggtitle("Top 20 Films With the Highest Production Budgets")

numbers_cleaned |>
  arrange(desc(profit)) |>
  slice_max(profit, n = 20) |>
  mutate(movie = fct_reorder(movie, profit)) |>
  ggplot(aes(x = movie, y = profit)) +
  geom_col(fill = "pink") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  theme_bw() +
  ggtitle("Top 20 Films With the Highest Profit")

numbers_cleaned |>
  arrange(desc(ROI)) |>
  slice_max(profit, n = 20) |>
  mutate(movie = fct_reorder(movie, ROI)) |>
  ggplot(aes(x = movie, y = ROI)) +
  geom_col(fill = "lightblue") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  theme_bw() +
  ggtitle("Top 20 Films With the Best Return on Investment")


```

Something interesting here is that Avatar: The Way of Water made a very high profit but had a relatively lower ROI compared to the other most profitable films.
Why might this be the case?
Avatar actually had the highest budget.
So in order to have a very high ROI, the film must make twice as much in profits.
The Minions movie on the other hand, is not even included in the top 20 highest budgets list and has the highest ROI despite having one of the lower profits compared to the other films.
Thus, we can see that the ROI score is more important than the profits made by a movie.
Your investment should be worth it!
This tells us that as the budget increases, the quality of the film must increase in order to truly get a good return on investment.'

This then depends on the over all likability of the film which is based on factors like genre, plot, actors, directors, length of film etc.
These factors are important to take into consideration to determine whether the audience will be bored of the film or not.
Hence, part 2 of this project will be taking a look at film likability.

## Part 2:

Let us now try to understand what makes a film popular.
We will do so by look at data from the [IMDb](https://www.imdb.com/search/title/?groups=top_1000) data about the top 1000 films.
This data includes the film title, genre, release year, directors, main actors, synopsis, IMDb ratings, rotten tomato ratings, overall meta score, production company, run time etc.
However, for this project, we will only be looking at the movie title, release year, genre, actors, synopsis, and IMDb rating.
The IMDB ratings "are based on simple numeric votes cast by users for a title, user reviews are written essays, in which IMDb users explain what they liked or disliked about a title and offer other criticism." Initially, I tried to scrape the website.
I was able to create a for loop that iterates through all 19 pages and scrape the information for each movie.
However, after thoroughly reading the IMDb website's terms of conditions, I found out that IMDb states that "You may not use data mining, robots, screen scraping, or similar data gathering and extraction tools on this site, except with our express written consent as noted below." Obtaining the written consent of the website owner is quite a hassle.
Hence, I switched to the use of an API tool (OMDb API).
I obtained an API key from the [OMDb API](https://www.omdbapi.com/apikey.aspx) website.
My API key was (5304cfc2) and the API tool has a limit of 1000 requests per day which is exhausted by just one iteration of the loop below. It is important to note that this code can only be run once with the given API. If you want to run it more than once, you must obtain a new API key from the website above. (Another API key you can try is 6ac0349a or d8edff88). Again, each API key only works once per day unfortunately. So, you would need to change the key if you need to run the code more than once. 
Next, I obtained the movie titles from the original IMDB website as mentioned above through some minimal scraping.
I used these movie titles to generate URLS for each movie in the top 1000 list.
These URLS were then used to extract specific information about each of the movies using the API.
I created a for loop to iterate through each URL, however, I ran into some errors with the content of certain movies.
Hence, I incorporated a tryCatch (recommended by my friend in the MSDS program!) in order to skip the movies that throw an error and continue on with the rest of the loop.
Two of the movies ended up throwing an error so I chose to exclude those from the overall analysis since it would be very time consuming to try to figure out the error in the contents and fix it so it can join the rest of the data frame.
Therefore, I ended up with a data frame of 998 of the most popular films.

```{r part 2a(web scraping), include=FALSE}
api.key.omdb <-  "5304cfc2"

IMDB_url <- "https://www.imdb.com/search/title/?groups=top_1000"

IMDB_page_num <- seq.int(51, 951, by = 50)

IMDB_urls <- paste0("https://www.imdb.com/search/title/?groups=top_1000&start=", IMDB_page_num, "&ref_=adv_nxt")


robotstxt::paths_allowed(IMDB_url)

movie_name <- bow(IMDB_url) |>
  scrape() |>
  html_elements("h3 a") |>
  html_text()

movie_names_list <- list()

for (i in seq_along(IMDB_urls)) {

  movie <- bow(IMDB_urls[i]) |>
    scrape() |>
   html_elements("h3 a") |>
    html_text()
  
  movie_names_list <- c(movie_names_list, movie)
}

movie_names_list <- c(movie_name, movie_names_list)


omdb_urls <- str_c("http://www.omdbapi.com/?apikey=", api.key.omdb,"&t=", URLencode(movie_names_list), "&y=&plot=short&r=json?")

IMDB_complete <- data.frame()

for (i in omdb_urls){
  tryCatch({
    film_content <- i |>
    fromJSON() |>
    as.data.frame() |>
    distinct(Title, .keep_all = TRUE)|>
    select(Title, Year, Rated, Runtime, Genre, Actors, Plot, imdbRating)
  
  IMDB_complete <- bind_rows(IMDB_complete, film_content)
  }, error = function(e){
    message("There is an Error in ", i, ":", e$message)
  })
  
}

```

We can now clean the data set to parse the character into numeric format.
We can also obtain the main genre of the film by extracting the first genre in the list of genres for each movie.
I'd assume that if the genre is listed first in a list that means its probably what the majority of the movie is focused on.
Then, I will obtain the lead actor of the film.

```{r part2b(cleaning)}
IMDB_cleaned <- IMDB_complete |>
  clean_names() 

IMDB_cleaned <- IMDB_cleaned|>
  mutate(year = parse_number(year),
         runtime = parse_number(runtime),
         imdb_rating = parse_number(imdb_rating),
         lead_actor = str_extract(actors, ".*,"),
         lead_actor = str_replace(lead_actor, ", .*,", ""),
         genre = str_extract(genre, "\\w+")) |>
  select(title, year, rated, runtime, genre, lead_actor, imdb_rating, plot)
```

## Exploring Likeability of a Film:

#### Genre:

Lets take a look at the most popular genre.
We can also take a look at the average ratings each genre received.

```{r part2c(genre)}
IMDB_cleaned |>
  group_by(genre) |>
  summarise(count = n()) |>
  ungroup() |>
  mutate(genre = fct_reorder(genre, desc(count))) |>
  ggplot(aes(x = genre, y = count, fill = genre)) +
  geom_col() +
  xlab("Genre") +
  ylab("Frequency") +
  ggtitle("Most Popular Genres by Count") +
  theme_bw() +
  theme(legend.position = "none")

IMDB_cleaned |>
  group_by(genre) |>
  summarise(average_imdb_rating = mean(imdb_rating)) |>
  ungroup() |>
  mutate(genre = fct_reorder(genre, desc(average_imdb_rating))) |>
  ggplot(aes(x = genre, y = average_imdb_rating, fill = genre)) +
  geom_col() +
  xlab("Genre") +
  ylab("Average Viewer Ratings") +
  ggtitle("Highest Rated Genre") +
  theme_bw() +
  theme(legend.position = "none")
  
```

It seems like Drama is the most popular genre of films closely followed by Action.
Unfortunately, fantasy, western, film, family, and thriller do not seem to be that popular with the general public.
Western, Family, and Thriller also seem to be losing in the race.
I guess those movies target a specific audience(eg. people who enjoy consuming fantasy media) while action seems to be suitable for everyone and drama may have more interesting plots.
But we will take a look at this a little later.
Further, While mystery films aren't very popular, the plot line seems to be good enough to be highly rated.
Most of the films in the data set are highly rated(that's why they are on the list!) I just wanted to take a look at whether certain genres are better rated than others which is not exactly the case.
However, the first graph still indicates that certain genres are more popular than others.
But there really does not seem to be a huge difference in ratings.
Right now, we can take a look at the most popular actors by looking at the actors that appear the most number of times in any of the top movies and comparing them to the average ratings their movies received.

#### Actors:

Lets take a look at the most popular actors.
We can do this by determining the actors with the most films in the list and the average ratings these films received.
We can determine this by looking at the actors with the most appearances in a film(4 or more appearances) and the average ratings of these movies.

```{r part 2d(actors)}
actor_popularity <- IMDB_cleaned |>
  group_by(lead_actor) |>
  summarise(number_of_appearances = n(),
            average_user_rating = mean(imdb_rating)) 

actor_popularity |>
   filter(number_of_appearances > 4) |>
  arrange(desc(number_of_appearances)) |>
  mutate(lead_actor = fct_reorder(lead_actor, number_of_appearances))|>
  ggplot(aes(x = lead_actor, y = number_of_appearances)) +
  geom_col(fill = "maroon") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  theme_bw() +
  ggtitle("Most Popular Actors")

actor_popularity |>
  filter(number_of_appearances > 4) |>
  arrange(desc(average_user_rating)) |>
  mutate(lead_actor = fct_reorder(lead_actor, average_user_rating))|>
  ggplot(aes(x = lead_actor, y = average_user_rating)) +
  geom_col(fill = "red") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  theme_bw() +
  ggtitle("Average Film Ratings for The Most Popular Actors")



  
```

Tom Hanks seems to be the most popular actor with 12 films in the list!
That's awesome!
He is closely followed by Robert De Niro.
Interestingly Charles Chaplin seems to have the highest overall user ratings on his films while Tom Hanks lies 9th on the list.
However, The ratings are still pretty high.
The films with these popular actors seem to have a good overall rating.
Something to note is that most of these actors have films in a variety of genres and yet movies with them have higher average ratings than movies of a specific genre.
So it seems that the actor playing in the movie has a higher emphasis on popularity of the move than the genre.
I guess if my favorite actor was in a movie I would still watch it regardless of the genre.
Makes sense!

#### Runtime:

Lets take a look at run time.
Are shorter movies preferred over longer ones.
I'm going to create a scatter plot to see whether run time has any effect on the user_rating of the film.

```{r part 2e(runtime), warning=FALSE, message=FALSE}
IMDB_cleaned |>
  ggplot(aes(x = runtime, y = imdb_rating, col = genre)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Effect of Runtime on Film Popularity Among Users by Genre") +
  theme_bw()
```

There seems to be an overall positive linear relationship between the two variables such that longer movies have higher user ratings.
Further, we can see that most action movies have longer run times than other movies and still have higher overall user_ratings.
So we can say that run time does have some dependence on popularity of the movie.
Maybe because a longer run time means that the viewers have more time to understand the film or the the director has more time to incorporate better scenes.

#### Movie Ratings:

We can take a look at which classification of a film seems to be the most popular.
We can create a graph showing the frequency of each rating certification in the imdb popularity list.

```{r part 2f(movie ratings)}
IMDB_cleaned |>
  group_by(rated) |>
  summarise(count = n()) |>
  ungroup() |>
  arrange(desc(count)) |>
  mutate(rated = fct_reorder(rated, count))|>
  ggplot(aes(x = rated, y = count, fill = rated)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma) +
  coord_flip(expand = FALSE) +
  labs(x = NULL) +
  xlab("Rating") +
  ylab("Frequency") +
  ggtitle("Most Popular Ratings by Count") +
  theme_bw() +
  theme(legend.position = "none")

```

The R rated movies seem to be the most popular films.
R: Restricted, Children Under 17 Require Accompanying Parent or Adult Guardian.
This rating means the film contains adult material such as adult activity, harsh language, intense graphic violence, drug abuse and nudity.
This means that many movies with violence or graphic contents seem to be the most popular.
This checks out.
Action and Drama are known to have graphic scenes, violence, or certain drama films having sexual content.
So we can say that rated R action and drama movies seem to be the most popular film types.

#### Sentiment Analysis:

Finally, we can take a look at what type of plot lines seem to be more popular.
In order to look at this category, I will be performing a sentiment analysis on the synopsis of each film to categorize the films into different sentiment categories.
Then, I will be calculating the frequency of each category to determine the most popular category.
Note: The lexicons used in the sentiment analysis are not comprehensive enough to contain all of the words in each and every synopsis in the data frame.
So, the lexicon is unable to find any match for some movie synopses.
For the comprehensive sentiment analysis using the "nrc" library, I will only be focusing on the matches found by the dictionary and we will assume that the non matched films are of a neutral sentiment.

```{r part 2g(sentiment analysis), message=FALSE, warning=FALSE}
tidy_films <- IMDB_cleaned |>
  select(title, plot) |> 
  unnest_tokens(word, plot) 
  
film_sentiment <- tidy_films |>
  anti_join(stop_words, by = c(word = "word")) |>
  inner_join(get_sentiments("nrc"), by = c(word = "word")) 

```

Lets take a look at which sentiment is the most popular among all these films.
We can do so by looking at a pie chart of the frequency of each sentiment.

```{r part 2h(sentiment analysis)}
film_sentiment |>
  group_by(sentiment) |>
  summarise(count = n()) |>
  ungroup() |>
  mutate(sentiment = fct_reorder(sentiment, desc(count))) |>
  ggplot(aes(x = sentiment, y = count, fill = sentiment)) +
  geom_col() +
  xlab("sentiment") +
  ylab("frequency") +
  ggtitle("Most Popular Sentiment by Count") +
  theme_bw() +
  theme(legend.position = "none")


  
  
```

Here we can see that films with negative sentiments seem to be more popular than positive sentiments.
Further, fear seems to be pretty popular as well.
We can take a look at action films.
These films tend to be more negative and fearful.
So this checks out.
With drama, it can be any sentiment really.
But its cool to take a look at want kind of sentiment you want your movie to have if you want to make sure it is a part of the top 1000 best films list and is popular among viewers.

#### Text Analysis:

We can take a look at the most common theme of words that appear in these films.
This can give us insight into whether there is a particular trend in the plot lines of the most popular films.
I will do so by creating a word cloud.
I used [this](https://towardsdatascience.com/create-a-word-cloud-with-r-bde3e7422e8a) and [this](https://www.geeksforgeeks.org/generating-word-cloud-in-r-programming/) as guides to create my word cloud.

```{r part 2i(text analysis)}
df <- tidy_films |>
  anti_join(stop_words, by = c(word = "word")) |>
  count(word) 

wordcloud(words = df$word, freq = df$n, min.freq = 1, max.words=100, random.order=FALSE, rot.per=0.35,            colors=brewer.pal(8, "Dark2"))


  
```

Words like "life", "World", "War", "family", and "love story" seem to be the most common followed by words like "woman", "murder", "mysterious", "murder" etc.
Based on my understanding, it seems like themes like war and coming home to a family/life of a soldier are the most common.
Hence, action based films just as we analyzed previously!
This seems to be followed by themes of love and suspense.
If you want to make your movie popular, be sure to follow these themes!


### Conclusion:

So what?
What do our analyses tell us?
What determines popularity of a film?
We need to make sure that our film has a great return on investment) despite what the profit is.
This means that depending on what our film budget is, we need to make sure the actual content of the film will become popular among viewers.
How can we do this?
We need to make sure our film has the genres of Drama, action, or comedy.
Our film should have one of the most popular actors from the list above(preferably Tom Hanks).
Depending on the genre, we must adjust the length of the film.
If it is an action film, it should be longer than 100 minutes in order to include the best action scenes!
Next, we would like to have the film be rated R.
So we could add some action packed graphic scenes(such as the ones in movies like the Avengers) since that's what viewers like.
Who doesn't love action packed super hero films?
Next, we need to change the plots.
We need to make sure our plot includes negative and fearful sentiments like deception or anger or murder.
There you go!
We have created the perfect film!
I'm sure it'll make it to the top 1000 most popular movies list!


```{r part 3(saving tidy the data)}
write_csv(numbers_cleaned, "numbers_cleaned.csv")
write_csv(IMDB_cleaned, "IMDb_cleaned.csv")
```



